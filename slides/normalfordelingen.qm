---
title: "Normalfordelingen"
format:
  revealjs:
    logo: ../pics/kubdatalab.png
engine: knitr
---

Når vi undersøger et eller andet, forsøger vi at finde ud af noget om virkeligheden.

* Hvad er den gennemsnitlige højde af alle mænd i Danmark?
* Hvad er det gennemsnitlige systoliske blodtryk for alle kvinder mellem 25 og 60 år i Tyskland?
* Indenfor hvilket interval ligger 95% af K-koncentrationen i serum for alle personer i Frankrig?

Det kan vi i almindelighed ikke finde ud af. Vi har ikke målt højden af alle mænd i Danmark. Vi har heller ikke været rundt og målt blodtryk for samtlige tyske kvinder i den relevante aldersgruppe. 

Men vi har taget en stikprøve. Og den kan vi bruge til at estimere den sande værdi.

Lige for data fra Danmark, kan vi nu ofte finde den sande værdi, for danskere er 
meget grundigt registrerede. Det er årsagen til at danske registerdata er så 
værdifulde. Og derfor ved vi ret præcist hvad den gennemsnitlige højde af danske 18-årige mænd (og om lidt alle danske 18-årige kvinder). Men det er usædvanligt.

Så hvordan estimerer vi den sande værdi?

Her skal vi have fat i normalfordelingen. Den kaldes normalfordelingen, fordi den er normal. Ikke normativt normal (noget er ikke forkert fordi det ikke er normalt). Men statistisk normal, fordi:

Når man undersøger fordelingen af ting, så er denne fordeling "normen", eller med 
et andet dansk udtryk - den typiske. Den hyppigst forekommende. 

Det viser sig også at hvis man har mange stikprøver af et eller andet, og beregner
middelværdien af alle disse stikprøver, så følger de her mange middelværdier normalfordelingen.

Det følger af "Den Centrale Grænseværdisætning". Og den matematik kommer vi ikke til at gå ind i, for det vi skal igennem er rigeligt kompliceret i forvejen. 

Så lad os nøjes med at konstatere at det gælder. Ved tilstrækkeligt mange stikprøver,
følger deres middelværdier normalfordelingen. Og den har nogen rare egenskaber som vi har stor glæde af.

## Det er en sandsynlighedsfordeling. Hvad er det?

Når vi undersøger et eller andet der kan have forskellige værdier, viser det sig 
at disse forskellige værdier optræder med forskellig sandsynlighed. Der er måler
der ses oftere end andre. I kommer til at se flere systoliske blodtryk omkring 120 mmHg,
end omkring 200 mmHg. (eller... I kommer nok ikke til at se så mange patienter der klager over at have et normalt blodtryk).

De her sandsynligheder kan fordele sig forskelligt, afhængig af hvad der egentlig styrer 
hvordan værdierne egentlig opstår. Så de kan se forskellige ud:

```{r 4-distibutions, echo  =F, fig.width=5, fig.height=5 }
# Generer data
library(tidyverse)
x <- seq(-4, 4, length.out = 100)

# Normal fordeling
normal <- dnorm(x, mean = 0, sd = 1)

# Student's t-fordeling med 3 frihedsgrader
student_t <- dt(x, df = 3)

# Chi-squared fordeling (forskudt til at passe bedre i plottet)
chi_sq <- dchisq(x + 2, df = 3)

# F-fordeling (også forskudt)
f_dist <- df(x + 2, df1 = 3, df2 = 10)

# Kombiner data
plot_data <- data.frame(x = x,
                        Normal = normal,
                        Student_t = student_t,
                        Chi_squared = chi_sq,
                        F_distribution = f_dist) |> 
  pivot_longer(-x, names_to = "Distribution", values_to = "Density")

# Lav plot med facetter
ggplot(plot_data, aes(x = x, y = Density)) +
  geom_line(linewidth = 1, colour = "steelblue") +
  facet_wrap(~Distribution, ncol = 2, scales = "free_y") +
  theme_minimal() +
  labs(title = "Four different probability distributions",
       x = "x",
       y = "Density") +
  theme(plot.title = element_text(hjust = 0.5))
```

Afhængig af den konkrete fordeling, er det forskellige ting der styrer dens udseende. 
Det de har til fælles er at arealet under kurven er 1. 1 svarer til 100%. Og når
sandsynlighedsfordelingen beskriver sandsynligheden for alle mulige værdier, så er 
den samlede sandsynlighed 100%

Normalfordelingen styres af værdiernes middelværdi, og deres standardafvigelse.

## Hvordan ser den ud?

$$
f(x) = \frac{1}{\sqrt{2\pi\sigma^2}} e^{-\frac{(x-\mu)^2}{2\sigma^2}}
$$

Vi kan se at den netop afhænger af to ting. En middelværdi $\mu$ og en standardafvigelse (I er glade for at kalde den en standarddeviation), $\sigma$
Men det er ikke så nyttigt. 

illustration - den findes på 
https://en.wikipedia.org/wiki/File:The_Normal_Distribution.svg
Og gemmes lokalt.

Det her er den normaliserede normalfordeling. Det er den hvor middelværdien er 0, og standardafvigelsen er 1. 

Hvilke egenskaber har den?


R har en række funktioner vi kan bruge:
```{r}
pnorm(-1.96)
qnorm(0.025)
dnorm(0.025)
```

Bemærk at vi starter længst ude til venstre. Så pnorm(-2)


```{r}
pnorm(-2)
```

fortæller os at 0.02275 eller 2.275% af observationerne er mindre end -2. Og husk at 
vi på X-aksen har enheder af sd. 

Den giver os arealet under kurven fra -uendelig til den værdi vi angiver.

Det betyder også at hvis vi skal have arealet mellem to værdier (eksempelvis -1.96 til 1.96), skal vi beregne hvad 
arealet fra -uendelig til 1.96 er
Og trække arealet fra -uendelig til -1.96 fra:


```{r}
pnorm(1.96)-pnorm(-1.96)
```

Med andre ord, 95% af observationerne ligger mellem -1.96 og 1.96.

## Og hvad når mine data ikke har en middelværdi på 0?

Jamen så normerer vi. 

Lad os tage nogen mere eller mindre tilfældige tal:


```{r}
exempel <- c(1,5,7,0,42,10,11,2)
(middel <- mean(exempel))
(sd_afv <- sd(exempel))
```

Så kan vi trække middelværdien fra alle tallene

```{r}
norm_middel <- exempel - middel
mean(norm_middel)
```

Standardafvigelsen er stadig ikke 0:


```{r}
(stdafv <- sd(norm_middel))



```

Men hvis vi dividerer tallene med standardafvigelsen:
```{r}
norm_middel_stdafv <- norm_middel/stdafv
mean(norm_middel_stdafv)
sd(norm_middel_stdafv)
```

Så har vi såkaldt normerede værdier, eller skalerede om man vil.

Og deres middelværdi er 0 (eller så tæt på at vi ikke kan se forskel)
Og deres standardafvigelse er 1.

Så kan vi bruge pnorm og de andre funktioner. Og når vi skal tilbage til de oprindelige tal - så ganger vi med den oprindelige standardafvigelse, og lægger den oprindelige middelværdi til.

Alternativt bruger vi et trick i pnorm/qnorm:


```{r}
pnorm(1.96, mean = 9.75, sd = 13.64604)
```

Øvelse

Hvis vi har en population med normalfordelte værdier der har en spredning på 
$\sigma = 6.52$ og 40% af værdierne er mindre end 0. Hvad er så middelværdien for
denne fordeling?

Vi ved ikke hvad middelværdien er. Men vi ved at standardafvigelsen er 6.52.

Så den er ikke normaliseret/skaleret. 

vores fordeling kalder vi for X. den er en normalfordeling N(mu, 6.52)

Så det skal nævnes, at notationen er N(mu, sd)

Vi er på jagt efter P(X<0) = 0.4

Det skal vi have normeret/skaleret:

P((X-mu)/6.52 < (0-mu)/6.52) = 0.4


```{r}
qnorm(0.4)
```

For at transformere vores værdier, skal vi trække \mu fra, og dividere med 
standardafvigelsen.

Det gælder også den 0 værdi vi leder efter

(0-mu)/sd


Yderligere øvelser
For en population af normalfordelte værdier ved vi at 50% af værdierne er mindre end 0.
Og at 60% af værdierne er mindre end 1. Hvad er middelværd og spredning for den 
population?

Der skal bruges lidt flere ord på beskrivelsen af fordelingen.
altså mere generelt at en fordeling X~N(mu,sigma) kan transformeres til 
(X-mu)/sigma.


Og så yderligere en række øvelser. Typeopgaverne her er tests af om man forstår normalfordelingen, og kan regne på den.